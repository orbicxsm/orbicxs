<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#111b21;display:flex;justify-content:center;min-height:100vh;color:#e9edef;}
    .app{width:100%;max-width:420px;background:#0b141a;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    .header{background:#00a884;color:#fff;padding:14px 16px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .back{position:absolute;left:16px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:24px;}
    .content{padding:40px 30px;text-align:center;}
    input,button{width:100%;padding:14px;margin:12px 0;border-radius:12px;font-size:16px;border:none;outline:none;}
    input{background:#1f2c34;color:#e9edef;}
    button{background:#00a884;color:#fff;cursor:pointer;font-weight:500;}
    .status{margin-top:15px;font-size:14px;}
    .error{color:#ff6b6b;}.success{color:#51cf66;}
    .search input{background:#1f2c34;color:#e9edef;padding:12px 16px;border-radius:25px;width:100%;border:none;outline:none;}
    .user-list{flex:1;overflow-y:auto;background:#111b21;}
    .user-item{display:flex;align-items:center;padding:14px 16px;cursor:pointer;border-bottom:1px solid #1f2c34;}
    .user-item:hover{background:#1f2c34;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:14px;}
    .name{font-weight:500;}
    .last{font-size:13px;color:#8696a0;margin-top:3px;}
    .messages{flex:1;overflow-y:auto;padding:10px 7%;background:#0b141a;}
    .msg{max-width:75%;padding:9px 13px;border-radius:12px;margin:8px 0;word-wrap:break-word;position:relative;}
    .sent{background:#005c4b;color:#fff;margin-left:auto;border-bottom-right-radius:4px;}
    .received{background:#1f2c34;color:#e9edef;margin-right:auto;border-bottom-left-radius:4px;}
    .msg img{max-width:100%;border-radius:12px;margin-top:6px;cursor:pointer;}
    .msg-time{font-size:11px;color:#8696a0;margin-top:4px;text-align:right;}
    .input-bar{padding:8px;background:#1f2c34;display:flex;align-items:center;gap:8px;}
    .attach,.send-btn{width:46px;height:46px;background:#2a3942;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#8696a0;}
    .send-btn{background:#00a884;color:#fff;}
    .msg-input{flex:1;padding:12px 16px;background:#2a3942;color:#e9edef;border-radius:25px;font-size:16px;outline:none;}
    .hidden{display:none!important;}
  </style>
</head>
<body>
  <div class="app">
    <!-- Email -->
    <div id="authStep">
      <div class="header">OrbicXs</div>
      <div class="content">
        <h2>Email kiriting</h2>
        <input id="email" type="email" placeholder="misol@gmail.com">
        <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
        <p id="status" class="status"></p>
      </div>
    </div>

    <!-- Username -->
    <div id="usernameStep" class="hidden">
      <div class="header">Username tanlang</div>
      <div class="content">
        <input id="usernameInput" placeholder="@javohir" maxlength="25">
        <button onclick="saveUsername()">SAQLASH</button>
      </div>
    </div>

    <!-- Chat ro'yxati -->
    <div id="usersStep" class="hidden">
      <div class="header">Xabarlar</div>
      <div style="padding:0 16px;margin-top:10px;">
        <input type="text" placeholder="Qidiruv..." oninput="handleSearch(this.value)">
      </div>
      <div class="user-list" id="userList">Yuklanmoqda...</div>
    </div>

    <!-- Chat -->
    <div id="chatStep" class="hidden" style="display:flex;flex-direction:column;height:100%;">
      <div class="header">
        <div class="back" onclick="backToList()">Back</div>
        <div style="margin-left:50px;display:flex;align-items:center;">
          <img id="chatAvatar" style="width:40px;height:40px;border-radius:50%;margin-right:12px;">
          <div>
            <div id="chatName" style="font-weight:500;"></div>
            <div style="font-size:13px;opacity:0.9;">online</div>
          </div>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-bar">
        <div class="attach" onclick="document.getElementById('fileInput').click()">Attach</div>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="sendImage(event)">
        <input class="msg-input" id="msgInput" placeholder="Xabar..." onkeypress="if(event.key==='Enter')sendMsg()">
        <div class="send-btn" onclick="sendMsg()">Send</div>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://osicrbckwwgoybnlhmrh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zaWNyYmNrd3dnb3libmxobXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODE0OTgsImV4cCI6MjA4MDc1NzQ5OH0.FFncYlnJwNklYdM3inCiZn3HATjQXpL5VbFmHxrjipw',
      { auth: { persistSession: true, storage: localStorage, autoRefreshToken: true } }
    );

    let me = null, myUsername = '', currentChat = null, subscription = null;

    // Sessiyani tiklash
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        me = session.user;
        loadMyProfile();
      }
    });

    supabase.auth.onAuthStateChange((_, session) => {
      if (session) {
        me = session.user;
        loadMyProfile();
      } else {
        show('authStep');
      }
    });

    async function loadMyProfile() {
      const { data } = await supabase.from('profiles').select('username').eq('id', me.id).single();
      if (data?.username) {
        myUsername = data.username.toLowerCase();
        show('usersStep');
        loadChats();
      } else {
        show('usernameStep');
      }
    }

    function sendMagicLink() {
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } })
        .then(() => document.getElementById('status').innerHTML = '<span class="success">Havola yuborildi!</span>');
    }

    async function saveUsername() {
      let u = document.getElementById('usernameInput').value.trim();
      if (!u) return alert("Username kiriting");
      if (!u.startsWith('@')) u = '@' + u;
      u = u.toLowerCase();

      const { data: exists } = await supabase.from('profiles').select('id').eq('username', u).single();
      if (exists) return alert("Bu username band");

      await supabase.from('profiles').update({ username: u }).eq('id', me.id);
      myUsername = u;
      show('usersStep');
      loadChats();
    }

    async function loadChats() {
      const { data } = await supabase.from('messages')
        .select('chat_id')
        .or(`sender.eq.${myUsername}`)
        .order('created_at', { ascending: false });

      const partners = new Set();
      data?.forEach(m => {
        const [a, b] = m.chat_id.split('_');
        const partner = a === myUsername ? b : a;
        partners.add(partner);
      });

      const list = document.getElementById('userList');
      list.innerHTML = '';
      if (partners.size === 0) {
        list.innerHTML = '<div style="text-align:center;padding:50px;color:#8696a0;">Hali suhbatlar yo ªq<br>Qidiruvdan odam toping</div>';
        return;
      }
      for (let p of partners) {
        const el = document.createElement('div');
        el.className = 'user-item';
        el.innerHTML = `<img src="https://ui-avatars.com/api/?name=${p}&background=00a884&color=fff&bold=true">
                        <div><div class="name">${p}</div><div class="last">suhbat</div></div>`;
        el.onclick = () => openChat(p);
        list.appendChild(el);
      }
    }

    async function handleSearch(q) {
      if (!q.trim()) return loadChats();
      const { data } = await supabase.from('profiles')
        .select('username')
        .ilike('username', `%${q.toLowerCase()}%`)
        .neq('username', myUsername);

      const list = document.getElementById('userList');
      list.innerHTML = '';
      data.forEach(p => {
        const el = document.createElement('div');
        el.className = 'user-item';
        el.innerHTML = `<img src="https://ui-avatars.com/api/?name=${p.username}&background=00a884&color=fff&bold=true">
                        <div><div class="name">${p.username}</div><div class="last">Yangi suhbat</div></div>`;
        el.onclick = () => openChat(p.username.toLowerCase());
        list.appendChild(el);
      });
    }

    function openChat(username) {
      currentChat = username;
      document.getElementById('chatName').textContent = username;
      document.getElementById('chatAvatar').src = `https://ui-avatars.com/api/?name=${username}&background=00a884&color=fff&bold=true`;
      document.getElementById('messages').innerHTML = '';
      show('chatStep');
      loadMessages();
    }

    function backToList() {
      if (subscription) subscription.unsubscribe();
      show('usersStep');
      loadChats();
    }

    async function sendMsg() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChat) return;
      const chatId = [myUsername, currentChat].sort().join('_');
      await supabase.from('messages').insert({ chat_id: chatId, sender: myUsername, text });
      input.value = '';
    }

    async function sendImage(e) {
      const file = e.target.files[0];
      if (!file || !currentChat) return;
      const ext = file.name.split('.').pop();
      const name = `${Date.now()}.${ext}`;
      const path = `${[myUsername, currentChat].sort().join('_')}/${name}`;
      await supabase.storage.from('chats').upload(path, file);
      const { data } = supabase.storage.from('chats').getPublicUrl(path);
      const chatId = [myUsername, currentChat].sort().join('_');
      await supabase.from('messages').insert({ chat_id: chatId, sender: myUsername, image_url: data.publicUrl });
    }

    function loadMessages() {
      const chatId = [myUsername, currentChat].sort().join('_');
      subscription = supabase.channel(chatId)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, p => addMessage(p.new))
        .subscribe();

      supabase.from('messages').select().eq('chat_id', chatId).order('created_at', { ascending: true })
        .then(({ data }) => data.forEach(addMessage));
    }

    function addMessage(m) {
      const isMe = m.sender === myUsername;
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'sent' : 'received'}`;
      const time = new Date(m.created_at).toLocaleTimeString('uz', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = m.image_url 
        ? `<img src="${m.image_url}" onclick="window.open(this.src)">`
        : `${m.text}<div class="msg-time">${time}</div>`;
      document.getElementById('messages').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }

    function show(id) {
      document.querySelectorAll('#authStep,#usernameStep,#usersStep,#chatStep').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
  </script>
</body>
</html>
