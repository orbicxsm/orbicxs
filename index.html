<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#111b21;display:flex;justify-content:center;min-height:100vh;}
    .app{width:100%;max-width:420px;background:#0b141a;color:#e9edef;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    .header{background:#00a884;padding:14px 16px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .header .back{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:24px;cursor:pointer;}
    .content{padding:40px 30px;text-align:center;}
    input,button{width:100%;padding:14px;margin:12px 0;border-radius:12px;font-size:16px;border:none;outline:none;}
    input{background:#1f2c34;color:#e9edef;}
    button{background:#00a884;color:#fff;cursor:pointer;font-weight:500;}
    button:hover{background:#008f6e;}
    .status{margin-top:15px;font-size:14px;}
    .error{color:#ff6b6b;}.success{color:#51cf66;}
    .search input{background:#1f2c34;color:#e9edef;padding:12px 16px;border-radius:25px;}
    .user-list{flex:1;overflow-y:auto;background:#111b21;}
    .user-item{display:flex;align-items:center;padding:14px 16px;cursor:pointer;border-bottom:1px solid #1f2c34;}
    .user-item:hover{background:#1f2c34;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:14px;}
    .user-item .name{font-weight:500;}
    .user-item .last{font-size:13px;color:#8696a0;margin-top:3px;}

    .chat-view{display:flex;flex-direction:column;height:100%;background:#0b141a;}
    .chat-header{background:#00a884;padding:12px 16px;display:flex;align-items:center;color:#fff;}
    .chat-header img{width:42px;height:42px;border-radius:50%;margin-right:12px;}
    .messages{flex:1;overflow-y:auto;padding:10px 7%;background:#0b141a;}
    .msg{max-width:75%;padding:9px 13px;border-radius:12px;margin:8px 0;word-wrap:break-word;}
    .sent{background:#005c4b;color:#fff;margin-left:auto;border-bottom-right-radius:4px;}
    .received{background:#1f2c34;color:#e9edef;margin-right:auto;border-bottom-left-radius:4px;}
    .msg img{max-width:100%;border-radius:12px;margin-top:6px;cursor:pointer;}
    .msg-time{font-size:11px;color:#8696a0;margin-top:4px;text-align:right;}

    .input-bar{padding:8px;background:#1f2c34;display:flex;align-items:center;gap:8px;}
    .input-bar .attach{width:46px;height:46px;background:#2a3942;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#8696a0;}
    .input-bar input{flex:1;padding:12px 16px;background:#2a3942;color:#e9edef;border-radius:25px;font-size:16px;}
    .input-bar button{width:46px;height:46px;background:#00a884;color:#fff;border-radius:50%;cursor:pointer;}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="app">

    <!-- Email kirish -->
    <div id="authStep">
      <div class="header">OrbicXs</div>
      <div class="content">
        <h2>Email kiriting</h2>
        <input id="email" type="email" placeholder="misol@gmail.com"/>
        <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
        <p id="status" class="status"></p>
      </div>
    </div>

    <!-- Username tanlash -->
    <div id="usernameStep" class="hidden">
      <div class="header">Username tanlang</div>
      <div class="content">
        <input id="username" placeholder="@ismoil" maxlength="25"/>
        <button onclick="saveUsername()">SAQLASH</button>
      </div>
    </div>

    <!-- Chatlar ro‘yxati -->
    <div id="usersStep" class="hidden">
      <div class="header">Xabarlar</div>
      <div class="search"><input type="text" placeholder="Qidiruv..." oninput="searchUsers(this.value)"></div>
      <div class="user-list" id="userList">
        <div style="text-align:center;padding:30px;color:#8696a0;">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Chat oynasi -->
    <div id="chatStep" class="hidden chat-view">
      <div class="chat-header">
        <div class="back" onclick="backToUsers()">Back</div>
        <img id="chatAvatar"/>
        <div class="info">
          <div class="name" id="chatWithName"></div>
          <div class="status">online</div>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-bar">
        <div class="attach" onclick="document.getElementById('fileInput').click()">Attach</div>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadImage(event)"/>
        <input id="msgInput" placeholder="Xabar..." onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg()}"/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://osicrbckwwgoybnlhmrh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zaWNyYmNrd3dnb3libmxobXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODE0OTgsImV4cCI6MjA4MDc1NzQ5OH0.FFncYlnJwNklYdM3inCiZn3HATjQXpL5VbFmHxrjipw',
      { auth: { persistSession: true, storage: localStorage } }
    );

    let user = null;
    let myUsername = '';
    let currentChatWith = null;
    let chatSub = null;

    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        user = session.user;
        loadProfile();
      } else {
        showStep('authStep');
      }
    });

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        user = session.user;
        loadProfile();
      }
    })();

    async function loadProfile() {
      const { data } = await supabase.from('profiles').select('username').eq('id', user.id).single();
      if (data?.username) {
        myUsername = data.username.toLowerCase();
        showStep('usersStep');
        showChatList();
      } else {
        showStep('usernameStep');
      }
    }

    async function sendMagicLink() {
      const email = document.getElementById('email').value.trim();
      if (!email) return status("Email kiriting!", "error");
      const { error } = await supabase.auth.signInWithOtp({ 
        email, 
        options: { emailRedirectTo: location.href }
      });
      if (error) status(error.message, "error");
      else status("Havola yuborildi! Spamni tekshiring", "success");
    }

    async function saveUsername() {
      let u = document.getElementById('username').value.trim();
      if (!u) return alert("Username kiriting!");
      if (!u.startsWith('@')) u = '@' + u;
      u = u.toLowerCase();

      const { data: exists } = await supabase.from('profiles').select('id').eq('username', u).maybeSingle();
      if (exists) return alert("Bu username band!");

      const { error } = await supabase.from('profiles').update({ username: u }).eq('id', user.id);
      if (error) return alert("Xato: " + error.message);

      myUsername = u;
      showStep('usersStep');
      showChatList();
    }

    // Faqat yozishgan odamlar chiqadi
    async function showChatList() {
      const { data: msgs } = await supabase.from('messages')
        .select('chat_id')
        .or(`sender.eq.${myUsername}`)
        .order('created_at', { ascending: false });

      const partners = new Set();
      msgs?.forEach(m => {
        const [a, b] = m.chat_id.split('_');
        const partner = a === myUsername ? b : a;
        partners.add(partner);
      });

      const list = document.getElementById('userList');
      list.innerHTML = '';
      if (partners.size === 0) {
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#8696a0;">Hali hech kim bilan yozishmadingiz.<br>Qidiruvdan yangi odam toping!</div>';
        return;
      }

      for (let p of partners) {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p)}&background=00a884&color=fff&bold=true&size=128"/>
          <div><div class="name">${p}</div><div class="last">suhbat</div></div>
        `;
        div.onclick = () => openChat(p);
        list.appendChild(div);
      }
    }

    // Qidiruv – yangi suhbat boshlash uchun
    window.searchUsers = async (q) => {
      if (!q.trim()) return showChatList();
      const { data } = await supabase.from('profiles')
        .select('username')
        .ilike('username', `%${q.toLowerCase()}%`)
        .neq('username', myUsername);

      const list = document.getElementById('userList');
      list.innerHTML = '';
      data.forEach(p => {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.username)}&background=00a884&color=fff&bold=true&size=128"/>
          <div><div class="name">${p.username}</div><div class="last">Yangi suhbat</div></div>
        `;
        div.onclick = () => openChat(p.username.toLowerCase());
        list.appendChild(div);
      });
    };

    function openChat(u) {
      currentChatWith = u;
      document.getElementById('chatWithName').textContent = u;
      document.getElementById('chatAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(u)}&background=00a884&color=fff&bold=true&size=128`;
      showStep('chatStep');
      document.getElementById('messages').innerHTML = '';
      loadMessages();
    }

    window.backToUsers = () => {
      if (chatSub) chatSub.unsubscribe();
      showStep('usersStep');
      showChatList();
      currentChatWith = null;
    };

    async function sendMsg() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChatWith) return;
      const chatId = [myUsername, currentChatWith].sort().join('_');
      await supabase.from('messages').insert({ chat_id: chatId, sender: myUsername, text });
      input.value = '';
    }

    async function uploadImage(e) {
      const file = e.target.files[0];
      if (!file || !currentChatWith) return;
      const ext = file.name.split('.').pop();
      const name = `${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
      const path = `${[myUsername, currentChatWith].sort().join('_')}/${name}`;
      await supabase.storage.from('chats').upload(path, file);
      const { data } = supabase.storage.from('chats').getPublicUrl(path);
      const chatId = [myUsername, currentChatWith].sort().join('_');
      await supabase.from('messages').insert({ chat_id: chatId, sender: myUsername, image_url: data.publicUrl });
    }

    function loadMessages() {
      if (!currentChatWith) return;
      const chatId = [myUsername, currentChatWith].sort().join('_');
      chatSub = supabase.channel(`chat:${chatId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, p => addMessage(p.new))
        .subscribe();

      supabase.from('messages').select().eq('chat_id', chatId).order('created_at', { ascending: true })
        .then(({ data }) => data.forEach(addMessage));
    }

    function addMessage(m) {
      const isMe = m.sender === myUsername;
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'sent' : 'received'}`;
      const time = new Date(m.created_at).toLocaleTimeString('uz', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = m.image_url 
        ? `<img src="${m.image_url}" onclick="window.open(this.src)"/>`
        : `${m.text}<div class="msg-time">${time}</div>`;
      document.getElementById('messages').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }

    function showStep(id) {
      document.querySelectorAll('#authStep,#usernameStep,#usersStep,#chatStep')
        .forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function status(t, type = "success") {
      const el = document.getElementById('status');
      el.textContent = t;
      el.className = 'status ' + type;
    }
  </script>
</body>
</html>
