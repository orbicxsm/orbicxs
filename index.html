<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OrbicXs – Global Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Oldingi CSS ni qoldiramiz – faqat kichik o‘zgartirishlar */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#f0f0f0;display:flex;justify-content:center;align-items:center;min-height:100vh;}
    .app{width:100%;max-width:420px;height:100vh;background:#fff;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 30px rgba(0,0,0,.15);}
    .header{background:#507ea8;color:#fff;padding:16px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .back{position:absolute;left:15px;top:15px;font-size:24px;cursor:pointer;z-index:10;}
    .content{padding:30px;text-align:center;}
    input,button{width:100%;padding:15px;margin:12px 0;border-radius:10px;border:none;font-size:16px;}
    input{background:#f5f5f5;}
    button{background:#507ea8;color:#fff;font-weight:500;cursor:pointer;}
    .hidden{display:none;}
    .spinner{margin:20px auto;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #507ea8;border-radius:50%;animation:s 1s linear infinite;}
    @keyframes s{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .msg img{cursor:pointer;max-width:100%;border-radius:12px;margin:5px 0;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);justify-content:center;align-items:center;z-index:999;}
    .modal img{max-width:94%;max-height:94%;border-radius:12px;}
    .modal-close{position:absolute;top:20px;right:20px;color:#fff;font-size:40px;cursor:pointer;}
  </style>
</head>
<body>

<div class="app">
  <!-- 1. Email kiritish -->
  <div id="authStep">
    <div class="header">OrbicXs Global</div>
    <div class="content">
      <h2>Xush kelibsiz!</h2>
      <p style="margin:20px 0;color:#555;">Emailingizni kiriting – havola yuboramiz</p>
      <input id="email" type="email" placeholder="email@gmail.com" autocomplete="email">
      <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
      <p id="status" style="margin-top:15px;font-size:15px;"></p>
      <div class="spinner hidden" id="spinner"></div>
    </div>
  </div>

  <!-- Qolgan qismlar (profile, users, chat) avvalgidek qoladi -->
  <!-- … (to‘liq kod pastda) … -->
</div>

<!-- Rasm kattalashtirish modal -->
<div id="imageModal" class="modal" onclick="this.style.display='none'">
  <span class="modal-close" onclick="document.getElementById('imageModal').style.display='none">×</span>
  <img id="bigImg">
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://fedtvocdgqhgerzspojg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlZHR2b2NkZ3FoZ2VyenNwb2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDM1MjcsImV4cCI6MjA4MDYxOTUyN30.Iv4vajez_sKQAziycpibt6kVThVV-7DQkEBgUAI4s8M'
  );

  let me = null;
  let myUsername = null;
  let currentChat = null;

  // Muhimi shu funksiya – har safar sahifa ochilganda sessiyani majburan tiklaymiz
  async function recoverSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      // Sessiya bor – uni majburan “faollashtiramiz”
      await supabase.auth.setSession(session);
      return session.user;
    }
    return null;
  }

  // Magic link yuborish
  async function sendMagicLink() {
    const email = document.getElementById('email').value.trim();
    if (!email) return status("Email kiriting", "red");

    document.getElementById('spinner').classList.remove('hidden');
    document.querySelector('button').disabled = true;

    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: location.href,           // juda muhim
        shouldCreateUser: true
      }
    });

    document.getElementById('spinner').classList.add('hidden');
    document.querySelector('button').disabled = false;

    if (error) {
      status(error.message, "red");
    } else {
      status("Havola emailingizga yuborildi! Spam papkasini ham tekshiring", "#4caf50");
    }
  }

  function status(text, color = "#4caf50") {
    const el = document.getElementById('status');
    el.textContent = text;
    el.style.color = color;
  }

  // Sahifa yuklanganda birinchi navbatda sessiyani tiklash
  (async () => {
    const user = await recoverSession();
    if (user) {
      me = user;
      // Profil bor-yo‘qligini tekshiramiz
      const { data } = await supabase.from('profiles').select('username').eq('id', me.id).single();
      myUsername = data?.username;

      if (!myUsername) {
        showScreen('profileStep');
      } else {
        showScreen('usersStep');
        updateOnline();
        setInterval(updateOnline, 25000);
      }
    } else {
      showScreen('authStep');
    }
  })();

  // Auth o‘zgarishi real-time kuzatiladi
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
      me = session.user;
      const { data } = await supabase.from('profiles').select('username').eq('id', me.id).single();
      myUsername = data?.username;

      if (!myUsername) {
        showScreen('profileStep');
      } else {
        showScreen('usersStep');
        updateOnline();
        setInterval(updateOnline, 25000);
      }
    }

    if (event === 'SIGNED_OUT') {
      me = null;
      myUsername = null;
      showScreen('authStep');
    }
  });

  function showScreen(id) {
    document.querySelectorAll('#authStep,#profileStep,#usersStep,#chatStep')
      .forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');

    // History API bilan telefon back tugmasi ishlashi uchun
    if (id === 'usersStep') history.replaceState({page:'users'}, '');
    if (id === 'chatStep') history.replaceState({page:'chat'}, '');
  }

  async function saveProfile() {
    // ... (oldingi kod bilan bir xil)
  }

  // Qolgan funksiyalar (searchUsers, openChat, sendMsg, rasm modal va h.k.) avvalgidek qoladi

  // Eng muhimi – havola bosilganda sahifa qayta yuklansa ham email so‘ramasligi uchun:
  // URL’da #access_token bor bo‘lsa – uni darhol ishlatamiz
  if (location.hash.includes('access_token')) {
    // magic linkdan kelgan
    setTimeout(() => location.hash = '', 1000); // # ni tozalaymiz, lekin sessiya qoladi
</script>
</body>
</html>
