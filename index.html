<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbicXs – Global Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#dbdbdb;display:flex;justify-content:center;min-height:100vh;align-items:center;}
    .app{width:100%;max-width:420px;height:100vh;background:#fff;display:flex;flex-direction:column;box-shadow:0 0 30px rgba(0,0,0,0.2);overflow:hidden;position:relative;}
    .header{background:#507ea8;color:#fff;padding:15px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .back{position:absolute;left:15px;top:15px;font-size:24px;cursor:pointer;z-index:10;}
    .content{padding:30px;text-align:center;}
    input, button{width:100%;padding:14px;margin:10px 0;border-radius:8px;border:none;font-size:16px;}
    input{background:#f0f0f0;}
    button{background:#507ea8;color:#fff;cursor:pointer;font-weight:500;transition:0.3s;}
    button:hover{background:#3b6b94;}
    .search{padding:12px;}
    .search input{background:#e8e8e8;border-radius:30px;padding-left:40px;}
    .user-list{flex:1;overflow-y:auto;background:#efeaee;}
    .user-item{display:flex;align-items:center;padding:15px 18px;cursor:pointer;border-bottom:1px solid #ddd;transition:0.2s;}
    .user-item:hover{background:#e0e0e0;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:15px;object-fit:cover;}
    .name{font-weight:500;font-size:17px;}
    .last{font-size:13px;color:#666;margin-top:3px;}
    .chat-view{background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAF0lEQVR4nGNkaP//PwMTAxMDE/8xA9MA8/8a1dMAAAAASUVORK5CYII=') repeat;flex:1;display:flex;flex-direction:column;}
    .chat-header{background:#507ea8;color:#fff;padding:12px;display:flex;align-items:center;}
    .chat-header img{width:40px;height:40px;border-radius:50%;margin:0 12px;object-fit:cover;}
    .chat-header .info{flex:1;}
    .chat-header .status{font-size:13px;opacity:0.9;}
    .messages{flex:1;overflow-y:auto;padding:10px;background:#e5ddd5;display:flex;flex-direction:column;gap:8px;}
    .msg{max-width:75%;padding:9px 13px;border-radius:18px;position:relative;word-wrap:break-word;}
    .sent{background:#d9fdd3;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
    .msg-time{font-size:11px;color:#888;margin-top:4px;text-align:right;}
    .input-bar{display:flex;align-items:center;padding:8px;background:#f0f0f0;}
    .input-bar input{flex:1;padding:12px 16px;border-radius:30px;border:none;background:#fff;margin:0 8px;outline:none;}
    .input-bar button{width:44px;height:44px;border-radius:50%;background:#507ea8;color:#fff;border:none;cursor:pointer;font-size:20px;}
    .hidden{display:none;}
    #profilePreview{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:20px auto;display:block;border:4px solid #507ea8;}
    .error-msg{color:red;font-size:14px;margin-top:10px;}
    .status-msg{margin-top:15px;font-size:15px;}
    .online{color:#4caf50 !important;font-weight:500;}
    #imageModal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.95);justify-content:center;align-items:center;}
    #imageModal img{max-width:95%;max-height:95%;border-radius:12px;}
    .close{position:absolute;top:20px;right:30px;color:#fff;font-size:50px;cursor:pointer;}
  </style>
</head>
<body>
<div class="app">
  <div id="authStep">
    <div class="header">OrbicXs Global</div>
    <div class="content">
      <h2 style="margin-bottom:20px;color:#333;">Xush kelibsiz!</h2>
      <input id="email" type="email" placeholder="email@gmail.com">
      <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
      <p class="status-msg" id="status"></p>
    </div>
  </div>

  <div id="profileStep" class="hidden">
    <div class="header"><span class="back" onclick="signOut()">Back</span>Profilni to'ldiring</div>
    <div class="content">
      <img id="profilePreview" src="https://via.placeholder.com/120/507ea8/ffffff?text=+">
      <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(event)">
      <button onclick="document.getElementById('avatarInput').click()">Rasm tanlash</button>
      <input id="username" type="text" placeholder="Ismingiz (masalan: Jamshid)" maxlength="20">
      <button onclick="saveProfile()">SAQLASH VA KIRISH</button>
      <p class="error-msg" id="profileError"></p>
    </div>
  </div>

  <div id="usersStep" class="hidden">
    <div class="header">Xabarlar</div>
    <div class="search"><input type="text" placeholder="Ism bo'yicha qidirish..." oninput="searchUsers(this.value.trim())"></div>
    <div class="user-list" id="userList"><p style="text-align:center;padding:50px;color:#777;">Ism kiriting...</p></div>
  </div>

  <div id="chatStep" class="hidden chat-view">
    <div class="chat-header">
      <span class="back" onclick="backToUsers()">Back</span>
      <img id="chatAvatar" src="https://via.placeholder.com/40">
      <div class="info">
        <div class="name" id="chatName"></div>
        <div class="status" id="chatStatus">offline</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(event)">
      <button onclick="document.getElementById('imgInput').click()">Attach</button>
      <input id="msgInput" placeholder="Xabar yozing..." onkeypress="if(event.key==='Enter') sendMsg()">
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>

<div id="imageModal" onclick="closeModal()">
  <span class="close" onclick="closeModal()">×</span>
  <img id="modalImage" src="">
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://fedtvocdgqhgerzspojg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlZHR2b2NkZ3FoZ2VyenNwb2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDM1MjcsImV4cCI6MjA4MDYxOTUyN30.Iv4vajez_sKQAziycpibt6kVThVV-7DQkEBgUAI4s8M'
  );

  let me = null, myUsername = null, currentChatId = null, currentReceiverId = null;

  function hideAll() {
    document.querySelectorAll('#authStep, #profileStep, #usersStep, #chatStep')
      .forEach(el => el.classList.add('hidden'));
  }

  function status(text, color = '#4caf50') {
    const el = document.getElementById('status');
    el.textContent = text;
    el.style.color = color;
  }

  async function sendMagicLink() {
    const email = document.getElementById('email').value.trim();
    if (!email) return status('Email kiriting!', 'red');
    localStorage.setItem('lastEmail', email);
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: location.origin + location.pathname }
    });
    if (error) return status(error.message, 'red');
    status('Havola emailingizga yuborildi! Tekshiring', '#4caf50');
  }

  function previewAvatar(e) {
    const file = e.target.files[0];
    if (file && file.size <= 5*1024*1024) {
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = 120; canvas.height = 120;
          canvas.getContext('2d').drawImage(img, 0, 0, 120, 120);
          document.getElementById('profilePreview').src = canvas.toDataURL();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    } else if (file) {
      alert('Rasm 5MB dan kichik boʻlsin!');
    }
  }

  async function saveProfile() {
    const username = document.getElementById('username').value.trim();
    if (username.length < 2) return document.getElementById('profileError').textContent = 'Ism 2+ harf boʻlsin!';

    let avatar_url = null;
    const file = document.getElementById('avatarInput').files[0];
    if (file) {
      const path = `${me.id}/${Date.now()}.${file.name.split('.').pop()}`;
      const { error: uploadError } = await supabase.storage.from('avatars').upload(path, file, { upsert: true });
      if (!uploadError) {
        avatar_url = supabase.storage.from('avatars').getPublicUrl(path).data.publicUrl;
      }
    }

    const { error } = await supabase.from('profiles').upsert({
      id: me.id, username, email: me.email, avatar_url
    });
    if (error) return document.getElementById('profileError').textContent = 'Xato: ' + error.message;

    myUsername = username;
    hideAll();
    document.getElementById('usersStep').classList.remove('hidden');
    restoreChatIfNeeded();
  }

  async function searchUsers(q) {
    const list = document.getElementById('userList');
    if (q.length < 2) return list.innerHTML = '<p style="text-align:center;padding:50px;color:#777;">Ism kiriting...</p>';

    const { data } = await supabase.from('profiles')
      .select('id, username, avatar_url')
      .ilike('username', `%${q}%`)
      .neq('id', me.id);

    list.innerHTML = '';
    if (!data || data.length === 0) return list.innerHTML = '<p style="text-align:center;padding:50px;color:#777;">Hech kim topilmadi</p>';

    data.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <img src="${u.avatar_url || 'https://via.placeholder.com/50/507ea8/fff?text='+u.username[0]}">
        <div><div class="name">${u.username}</div></div>
      `;
      div.onclick = () => openChat(u.id, u.username, u.avatar_url);
      list.appendChild(div);
    });
  }

  function openChat(userId, username, avatar) {
    currentReceiverId = userId;
    currentChatId = [me.id, userId].sort().join('_');
    localStorage.setItem('lastChat', JSON.stringify({userId, username, avatar, chatId: currentChatId}));

    document.getElementById('chatName').textContent = username;
    document.getElementById('chatAvatar').src = avatar || 'https://via.placeholder.com/40';
    hideAll();
    document.getElementById('chatStep').classList.remove('hidden');
    document.getElementById('messages').innerHTML = '';
    loadMessages();
    history.pushState({page: 'chat'}, '', location.pathname);
  }

  function backToUsers() {
    localStorage.removeItem('lastChat');
    currentChatId = null;
    currentReceiverId = null;
    hideAll();
    document.getElementById('usersStep').classList.remove('hidden');
    history.pushState({page: 'users'}, '', location.pathname);
  }

  async function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !currentChatId) return;
    await supabase.from('messages').insert({
      chat_id: currentChatId,
      sender_id: me.id,
      receiver_id: currentReceiverId,
      text
    });
    input.value = '';
  }

  async function sendImage(e) {
    const file = e.target.files[0];
    if (!file || file.size > 5*1024*1024) return alert('Rasm 5MB dan kichik boʻlsin!');

    const reader = new FileReader();
    reader.onload = async ev => {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = Math.min(800, img.width);
        canvas.height = canvas.width * (img.height / img.width);
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
        const path = `chat_images/${me.id}/${Date.now()}.jpg`;
        const { error: uploadError } = await supabase.storage.from('chat_images').upload(path, blob);
        if (uploadError) return;
        const url = supabase.storage.from('chat_images').getPublicUrl(path).data.publicUrl;

        await supabase.from('messages').insert({
          chat_id: currentChatId,
          sender_id: me.id,
          receiver_id: currentReceiverId,
          text: `<a href="${url}" download><img src="${url}" style="max-width:100%;border-radius:12px;margin:5px 0;cursor:pointer;" onclick="event.stopPropagation();openModal('${url}')"></a>`
        });
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  async function loadMessages() {
    const { data } = await supabase.from('messages')
      .select().eq('chat_id', currentChatId)
      .order('created_at', { ascending: true });

    const container = document.getElementById('messages');
    container.innerHTML = '';
    data.forEach(m => addMessage(m, container));
    container.scrollTop = container.scrollHeight;

    supabase.channel('chat')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChatId}` },
        payload => { addMessage(payload.new, container); container.scrollTop = container.scrollHeight; }
      ).subscribe();
  }

  function addMessage(m, container) {
    const isMe = m.sender_id === me.id;
    const div = document.createElement('div');
    div.className = `msg ${isMe ? 'sent' : 'received'}`;
    div.innerHTML = m.text + `<div class="msg-time">${new Date(m.created_at).toLocaleTimeString('uz', {hour:'2-digit', minute:'2-digit'})}</div>`;
    container.appendChild(div);
  }

  function openModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('imageModal').style.display = 'none';
  }

  async function signOut() {
    localStorage.clear();
    await supabase.auth.signOut();
    location.reload();
  }

  function restoreChatIfNeeded() {
    const saved = localStorage.getItem('lastChat');
    if (saved) {
      const {userId, username, avatar} = JSON.parse(saved);
      openChat(userId, username, avatar);
    }
  }

  supabase.auth.onAuthStateChange(async (event, session) => {
    me = session?.user ?? null;
    if (!me) {
      const lastEmail = localStorage.getItem('lastEmail');
      if (lastEmail) document.getElementById('email').value = lastEmail;
      hideAll();
      document.getElementById('authStep').classList.remove('hidden');
      return;
    }

    if (location.hash.includes('access_token')) {
      history.replaceState(null, null, location.pathname);
    }

    const { data: profile } = await supabase.from('profiles').select('username').eq('id', me.id).single();

    if (!profile?.username) {
      hideAll();
      document.getElementById('profileStep').classList.remove('hidden');
    } else {
      myUsername = profile.username;
      hideAll();
      document.getElementById('usersStep').classList.remove('hidden');
      restoreChatIfNeeded();
    }
  });

  window.addEventListener('popstate', () => {
    if (!document.getElementById('chatStep').classList.contains('hidden')) {
      backToUsers();
    }
  });

  window.addEventListener('load', async () => {
    const { data } = await supabase.auth.getSession();
    if (location.hash.includes('access_token')) {
      setTimeout(async () => {
        await supabase.auth.getSession();
      }, 1500);
    }
  });
</script>
</body>
</html>
